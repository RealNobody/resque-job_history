<link href="job_history/public/job_history.css" media="screen" rel="stylesheet" type="text/css">

<h1>Job Classes</h1>

<table>
  <tr>
    <th><a href="job%20history?<%= { sort: "class_name" }.to_param %>">Class name</a></th>
    <th><a href="job%20history?<%= { sort: "running_jobs" }.to_param %>">Running</a></th>
    <th><a href="job%20history?<%= { sort: "total_finished_jobs" }.to_param %>">Finished</a></th>
    <th><a href="job%20history?<%= { sort: "max_running_jobs" }.to_param %>">Max Running</a></th>
    <th><a href="job%20history?<%= { sort: "start_time" }.to_param %>">Last Run Start</a></th>
    <th><a href="job%20history?<%= { sort: "durration" }.to_param %>">Last Run Duration</a></th>
    <th><a href="job%20history?<%= { sort: "success" }.to_param %>">Last Run successful</a></th>
  </tr>

  <% Resque::Plugins::JobHistory::JobViewer::ClassMethods.job_summaries(@sort_by).each do |class_info| %>
    <tr>
      <td>
        <a href="job%20history/job_class_details?class_name=<%= class_info[:class_name] %>">
          <%= class_info[:class_name] %>
        </a>
      </td>
      <td>
        <%= class_info[:running_jobs].to_i %>
      </td>
      <td>
        <%= class_info[:total_finished_jobs].to_i %>
      </td>
      <td>
        <%= class_info[:max_running_jobs].to_i %>
      </td>
      <td>
        <% if class_info[:last_run][:start_time] %>
          <%= time_ago_in_words(class_info[:last_run][:start_time]) %> ago
          (<%= class_info[:last_run][:start_time] %>)
        <% end %>
      </td>
      <td>
        <% if class_info[:last_run][:start_time] %>
          <% if class_info[:last_run][:end_time] %>
            <%= distance_of_time_in_words(class_info[:last_run][:start_time], (class_info[:last_run][:end_time] || Time.now)) %>
            (<%= class_info[:last_run][:end_time] %>)
          <% else %>
            Still running...
          <% end %>
        <% end %>
      </td>
      <td>
        <% if class_info[:last_run][:error] %>
          No
        <% else %>
          Yes
        <% end %>
      </td>
    </tr>
  <% end %>
</table>

<br/>

<form method="POST" action="job%20history/purge_all">
  <input type="submit" name="" value="Purge all histories"/>
</form>
